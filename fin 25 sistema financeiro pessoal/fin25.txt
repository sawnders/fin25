<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Financeiro Pessoal</title>
    <style>
        /* --- ESTILOS GERAIS E LAYOUT --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f9;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* --- ESTILOS DE COMPONENTES --- */
        .collapsible-header {
            background-color: #f0f0f0;
            color: #333;
            padding: 15px;
            cursor: pointer;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
            transition: background-color 0.2s;
        }
        
        .collapsible-header:hover {
            background-color: #e2e2e2;
        }

        .arrow {
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin-bottom: 20px;
        }
        
        .collapsible-content.expanded {
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }

        input[type="date"], 
        input[type="text"], 
        input[type="number"], 
        select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }
        
        /* --- BOT√ïES --- */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, opacity 0.2s;
            white-space: nowrap; 
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #a71d2a;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #0c8a9f;
        }

        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        /* --- DASHBOARD --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-item {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            border: 1px solid #eee;
        }

        .dashboard-valor {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0 0;
            transition: color 0.3s, background-color 0.3s;
        }

        .soma-positiva {
            color: #28a745;
        }
        
        .soma-negativa {
            color: #dc3545;
        }
        
        .soma-neutra {
             color: #6c757d;
        }

        .dashboard-title {
            font-size: 0.9em;
            color: #666;
        }

        .valor-oculto {
            color: transparent !important;
            background-color: #ccc; 
            border-radius: 4px;
            height: 1.1em;
            display: inline-block; 
            min-width: 100px;
        }
        
        .privacidade-toggle {
            float: right;
            font-size: 1.2em;
            padding: 5px 10px;
        }

        /* --- RELAT√ìRIO E TABELA --- */
        .relatorio-filtros {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .relatorio-filtros > div {
            flex-basis: calc(25% - 10px); 
            min-width: 150px;
        }
        
        .relatorio-resumo {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #007bff;
            border-radius: 6px;
            background-color: #e9f5ff;
            display: flex;
            justify-content: space-around;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
            font-size: 0.9em;
        }

        th {
            background-color: #007bff;
            color: white;
            text-transform: uppercase;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .status-vencido {
            background-color: #ffcccc; 
            color: #000000;
            font-weight: bold;
        }
        
        .status-pendente {
            background-color: #fff3cd; 
            color: #856404;
            font-weight: bold;
        }

        /* --- MODAL (CONFIGURA√á√ïES E DETALHES) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 25px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* --- ESTILOS DE CATEGORIAS NO MODAL --- */
        .lista-categorias-ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        
        .lista-categorias-ul li {
            border-bottom: 1px dashed #eee;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .lista-categorias-ul li:last-child {
            border-bottom: none;
        }
        
        /* --- CALCULADORA --- */
        .calculadora {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            max-width: 300px;
            margin: 20px auto 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #displayCalc {
            grid-column: span 4;
            background-color: #222;
            color: white;
            padding: 15px;
            text-align: right;
            font-size: 2em;
            border-radius: 5px;
            margin-bottom: 5px;
            overflow: hidden; 
            white-space: nowrap; 
        }

        .calc-btn {
            padding: 15px;
            font-size: 1.1em;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background-color: #e9e9e9;
            transition: background-color 0.1s;
        }

        .calc-btn:hover {
            background-color: #d1d1d1;
        }

        .operador {
            background-color: #ff9500;
            color: white;
        }

        .operador:hover {
            background-color: #e08500;
        }

        .clear {
            background-color: #ff3b30;
            color: white;
        }

        .clear:hover {
            background-color: #e02f23;
        }
        
    </style>
</head>
<body>

    <div class="container">
        <h1>Gerenciador Financeiro Pessoal</h1>

        <div class="collapsible-header" onclick="toggleSection('dashboardContent')">
            Dashboard (Resumo) <button id="privacidadeToggle" class="btn btn-secondary privacidade-toggle" onclick="togglePrivacidade(event)">üîí</button> <span class="arrow">‚ñº</span>
        </div>
        <div class="collapsible-content" id="dashboardContent">
            <div class="dashboard">
                <div class="dashboard-item" style="grid-column: span 4; background-color: #e9f5ff; border: 2px solid #007bff;">
                    <div class="dashboard-title">SALDO TOTAL ATUAL (Quitado/Recebido)</div>
                    <p id="saldoAtual" class="dashboard-valor soma-neutra">R$ 0,00</p>
                </div>
            </div>
            
            <div class="dashboard">
                <div class="dashboard-item">
                    <div class="dashboard-title">Receitas Quitadas no M√™s</div>
                    <p id="receitasMes" class="dashboard-valor soma-positiva">R$ 0,00</p>
                </div>
                <div class="dashboard-item">
                    <div class="dashboard-title">Despesas Pagas no M√™s</div>
                    <p id="despesasMes" class="dashboard-valor soma-negativa">R$ 0,00</p>
                </div>
                <div class="dashboard-item" style="background-color: #ffe6e6;">
                    <div class="dashboard-title">Contas A Pagar</div>
                    <p id="aPagarCount" class="dashboard-valor soma-negativa">0</p>
                </div>
                <div class="dashboard-item" style="background-color: #e6ffe6;">
                    <div class="dashboard-title">Contas A Receber</div>
                    <p id="aReceberCount" class="dashboard-valor soma-positiva">0</p>
                </div>
                <div class="dashboard-item" style="background-color: #fff3cd;">
                    <div class="dashboard-title">Pendente</div>
                    <p id="pendentesCount" class="dashboard-valor soma-neutra">0</p>
                </div>
                 <div class="dashboard-item" style="background-color: #eee;">
                    <div class="dashboard-title">Total de Transa√ß√µes Quitadas</div>
                    <p id="pagosRecebidosCount" class="dashboard-valor soma-neutra">0</p>
                </div>
            </div>
        </div>

        <div class="collapsible-header" onclick="toggleSection('transacaoContent')">
            Nova Transa√ß√£o <span class="arrow">‚ñº</span>
        </div>
        <div class="collapsible-content" id="transacaoContent">
            <div class="form-row">
                <div>
                    <label for="dataTransacao">Data de Vencimento/Compet√™ncia</label>
                    <input type="date" id="dataTransacao" required>
                </div>
                <div>
                    <label for="tipoTransacao">Tipo</label>
                    <select id="tipoTransacao" onchange="atualizarStatusPadrao(); carregarCategoriasESubcategorias()">
                        <option value="despesa">Despesa</option>
                        <option value="receita">Receita</option>
                    </select>
                </div>
                <div>
                    <label for="statusTransacao">Status</label>
                    <select id="statusTransacao"></select>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="valorTransacao">Valor Total (R$)</label>
                    <input type="number" id="valorTransacao" step="0.01" min="0.01" required>
                </div>
                <div>
                    <label for="parcelas">N√∫mero de Parcelas</label>
                    <input type="number" id="parcelas" min="1" value="1" required>
                </div>
            </div>
            
            <div class="form-row">
                 <div>
                    <label for="categoriaTransacao">Categoria <button class="btn btn-secondary" style="padding: 3px 6px; font-size: 0.8em; margin-left: 5px;" onclick="abrirModalCategorias()">+</button></label>
                    <select id="categoriaTransacao" onchange="carregarSubcategoriasPorCategoria()" required>
                        <option value="">Selecione uma categoria</option>
                    </select>
                </div>
                <div>
                    <label for="subcategoriaTransacao">Subcategoria (Opcional)</label>
                    <select id="subcategoriaTransacao">
                        <option value="">Selecione uma subcategoria</option>
                    </select>
                </div>
            </div>

            <label for="lojaTransacao">Loja/Origem</label>
            <input type="text" id="lojaTransacao" list="listaLojas" autocomplete="off">
            <datalist id="listaLojas"></datalist>

            <label for="descricaoTransacao">Descri√ß√£o</label>
            <input type="text" id="descricaoTransacao" required>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="salvarTransacao()">Salvar Transa√ß√£o</button>
                <button class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
            </div>
        </div>

        <div class="collapsible-header" onclick="toggleSection('relatorioContent')">
            Relat√≥rios e Extrato <span class="arrow">‚ñº</span>
        </div>
        <div class="collapsible-content" id="relatorioContent">
            <h2>Filtros</h2>
            <div class="relatorio-filtros">
                <div>
                    <label for="filtroPeriodo">Per√≠odo</label>
                    <select id="filtroPeriodo" onchange="toggleDateFilters()">
                        <option value="mes">M√™s Atual</option>
                        <option value="3meses">√öltimos 3 Meses</option>
                        <option value="6meses">√öltimos 6 Meses</option>
                        <option value="1ano">√öltimo Ano</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>
                <div id="filtroDataPersonalizada" style="display: none;">
                    <label for="dataInicio">De</label>
                    <input type="date" id="dataInicio">
                </div>
                <div id="filtroDataPersonalizada2" style="display: none;">
                    <label for="dataFim">At√©</label>
                    <input type="date" id="dataFim">
                </div>
                <div>
                    <label for="filtroTipo">Tipo</label>
                    <select id="filtroTipo">
                        <option value="">Todos</option>
                        <option value="despesa">Despesa</option>
                        <option value="receita">Receita</option>
                    </select>
                </div>
                <div>
                    <label for="filtroCategoria">Categoria</label>
                    <select id="filtroCategoria">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div>
                    <label for="filtroBusca">Busca (Desc/Loja)</label>
                    <input type="text" id="filtroBusca">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>

            <div class="relatorio-resumo">
                <p>Receitas Quitadas: <span id="somaReceitas" class="soma-positiva">R$ 0,00</span></p>
                <p>Despesas Pagas: <span id="somaDespesas" class="soma-negativa">R$ 0,00</span></p>
                <p>Saldo do Per√≠odo: <span id="saldoRelatorio" class="soma-neutra">R$ 0,00</span></p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo</th>
                        <th>Categoria</th>
                        <th>Subcategoria</th>
                        <th>Valor (R$)</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaRelatorioBody">
                    </tbody>
            </table>
        </div>

        <div class="collapsible-header" onclick="toggleSection('configContent')">
            Configura√ß√µes e Ajuda <span class="arrow">‚ñº</span>
        </div>
        <div class="collapsible-content" id="configContent">
            <h2>Ferramentas</h2>

            <h3>Calculadora R√°pida</h3>
            <div class="calculadora">
                <div id="displayCalc">0</div>
                <button class="calc-btn clear" onclick="limparCalc()">C</button>
                <button class="calc-btn clear" onclick="apagarCalc()">‚Üê</button>
                <button class="calc-btn operador" onclick="operadorCalc('/')">√∑</button>
                <button class="calc-btn operador" onclick="operadorCalc('*')">√ó</button>
                <button class="calc-btn" onclick="digitoCalc('7')">7</button>
                <button class="calc-btn" onclick="digitoCalc('8')">8</button>
                <button class="calc-btn" onclick="digitoCalc('9')">9</button>
                <button class="calc-btn operador" onclick="operadorCalc('-')">-</button>
                <button class="calc-btn" onclick="digitoCalc('4')">4</button>
                <button class="calc-btn" onclick="digitoCalc('5')">5</button>
                <button class="calc-btn" onclick="digitoCalc('6')">6</button>
                <button class="calc-btn operador" onclick="operadorCalc('+')">+</button>
                <button class="calc-btn" onclick="digitoCalc('1')">1</button>
                <button class="calc-btn" onclick="digitoCalc('2')">2</button>
                <button class="calc-btn" onclick="digitoCalc('3')">3</button>
                <button class="calc-btn operador" onclick="igualCalc()">=</button>
                <button class="calc-btn" onclick="digitoCalc('0')">0</button>
                <button class="calc-btn" onclick="digitoCalc(',')">,</button>
            </div>
            
            <h3>Resetar Todos os Dados</h3>
            <p><strong>ATEN√á√ÉO:</strong> Esta a√ß√£o √© irrevers√≠vel e apagar√° todas as transa√ß√µes, categorias e lojas.</p>
            <input type="password" id="senhaReset" placeholder="Senha de Reset">
            <button class="btn btn-danger" onclick="resetarDados()">Confirmar Reset</button>
            
        </div>

    </div>

    <div id="modalCategorias" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModalCategorias()">&times;</span>
            <h2>Gerenciar Categorias</h2>
            
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Nova Categoria</h3>
                    <label for="modalTipo">Tipo:</label>
                    <select id="modalTipo" style="width: 100%;" onchange="carregarCategoriasModal()">
                        <option value="despesa">Despesa</option>
                        <option value="receita">Receita</option>
                    </select>
                    <label for="modalNovaCategoria">Nome da Categoria:</label>
                    <input type="text" id="modalNovaCategoria" placeholder="Ex: Alimenta√ß√£o, Sal√°rio">
                    <button class="btn btn-primary" onclick="cadastrarCategoriaModal()">Cadastrar Categoria</button>
                </div>
                
                <div style="flex: 1;">
                    <h3>Nova Subcategoria</h3>
                    <label for="modalSubCategoriaPai">Categoria Pai:</label>
                    <select id="modalSubCategoriaPai" style="width: 100%;">
                        <option value="">Selecione uma categoria</option>
                    </select>
                    
                    <label for="modalNovaSubcategoria">Nome da Subcategoria:</label>
                    <input type="text" id="modalNovaSubcategoria" placeholder="Ex: Supermercado, Restaurante">
                    <button class="btn btn-primary" onclick="cadastrarSubcategoriaModal()">Cadastrar Subcategoria</button>
                </div>
            </div>

            <hr style="margin-top: 20px;">

            <h3>Categorias Existentes (Clique em X para Excluir)</h3>
            <div id="categoriasDisplay">
                </div>
        </div>
    </div>

    <div id="modalDetalhesTransacao" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModalDetalhes()">&times;</span>
            <h2>Detalhes da Transa√ß√£o Original</h2>
            <div id="detalhesDisplay">
                </div>
        </div>
    </div>


<script>
    // --- VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ÉO ---
    const PASS_RESET = "123456"; // Senha de reset 
    let isPrivacidadeAtiva = true; // Inicia ativado
    // Vari√°veis da calculadora
    let displayValue = '0';
    let primeiroOperando = null;
    let operadorPendente = null;
    let aguardandoSegundoOperando = false;
    
    // --- UTILS ---
    const formatarMoeda = (valor) => {
        if (!isFinite(valor) || valor === null) {
            return 'R$ 0,00';
        }
        return `R$ ${parseFloat(valor).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
    };

    // --- FUN√á√ïES DE ARMAZENAMENTO (LOCALSTORAGE) ---
    function getTransacoes() {
        return JSON.parse(localStorage.getItem('transacoes')) || [];
    }

    function setTransacoes(transacoes) {
        localStorage.setItem('transacoes', JSON.stringify(transacoes));
    }
    
    function getCategorias() {
        // Estrutura: { despesa: { 'Categoria X': {nome: 'Cat X', subcategorias: []} }, receita: {...} }
        const categorias = localStorage.getItem('categorias');
        if (!categorias) {
            // Inicializa com categorias padr√£o
            const categoriasPadrao = {
                despesa: {
                    'Alimenta√ß√£o': { nome: 'Alimenta√ß√£o', subcategorias: ['Supermercado', 'Restaurante'] },
                    'Transporte': { nome: 'Transporte', subcategorias: ['Combust√≠vel', '√înibus'] },
                    'Moradia': { nome: 'Moradia', subcategorias: ['Aluguel', 'Contas'] }
                },
                receita: {
                    'Sal√°rio': { nome: 'Sal√°rio', subcategorias: [] },
                    'Freelancer': { nome: 'Freelancer', subcategorias: [] }
                }
            };
            localStorage.setItem('categorias', JSON.stringify(categoriasPadrao));
            return categoriasPadrao;
        }
        return JSON.parse(categorias);
    }

    function setCategorias(categorias) {
        localStorage.setItem('categorias', JSON.stringify(categorias));
    }
    
    function getLojas() {
        return JSON.parse(localStorage.getItem('lojas')) || [];
    }

    function setLojas(lojas) {
        localStorage.setItem('lojas', JSON.stringify(lojas));
    }

    // --- FUN√á√ïES DE USABILIDADE ---
    
    function atualizarStatusPadrao() {
        const tipo = document.getElementById('tipoTransacao').value;
        const statusSelect = document.getElementById('statusTransacao');
        
        statusSelect.innerHTML = '';
        
        if (tipo === 'despesa') {
            statusSelect.innerHTML = `
                <option value="A Pagar">A Pagar</option>
                <option value="Pendente">Pendente</option>
                <option value="Pago">Pago</option>
            `;
            statusSelect.value = 'A Pagar';
        } else {
            statusSelect.innerHTML = `
                <option value="A Receber">A Receber</option>
                <option value="Pendente">Pendente</option>
                <option value="Recebido">Recebido</option>
            `;
            statusSelect.value = 'A Receber';
        }
    }
    
    function toggleSection(contentId) {
        const content = document.getElementById(contentId);
        const header = content.previousElementSibling;
        const arrow = header.querySelector('.arrow');

        const isExpanded = content.classList.contains('expanded');

        // Fechar
        if (isExpanded) {
            content.style.maxHeight = content.scrollHeight + 'px'; // For√ßa a transi√ß√£o a come√ßar do tamanho atual
            setTimeout(() => {
                content.style.maxHeight = '0px';
                content.classList.remove('expanded');
                arrow.style.transform = 'rotate(0deg)';
            }, 10);
        } 
        // Abrir
        else {
            // Fechar outras se√ß√µes antes de abrir (opcional, mas melhora a UX)
             document.querySelectorAll('.collapsible-content.expanded').forEach(otherContent => {
                 if(otherContent.id !== contentId) {
                     otherContent.style.maxHeight = '0px';
                     otherContent.classList.remove('expanded');
                     otherContent.previousElementSibling.querySelector('.arrow').style.transform = 'rotate(0deg)';
                 }
             });


            content.classList.add('expanded');
            content.style.maxHeight = content.scrollHeight + 'px'; 
            arrow.style.transform = 'rotate(180deg)';
            
            // Depois da transi√ß√£o, define max-height alto para permitir crescimento do conte√∫do
            content.addEventListener('transitionend', function handler() {
                if (content.classList.contains('expanded')) {
                    content.style.maxHeight = '4000px'; 
                }
                content.removeEventListener('transitionend', handler);
            });
        }
    }
    
    function togglePrivacidade(event) {
        event.stopPropagation();
        isPrivacidadeAtiva = !isPrivacidadeAtiva;
        const toggleButton = document.getElementById('privacidadeToggle');
        const dashboardValues = document.querySelectorAll('.dashboard-valor');

        toggleButton.innerHTML = isPrivacidadeAtiva ? 'üîí' : '&#x1f441;'; 
        
        dashboardValues.forEach(p => {
            p.classList.toggle('valor-oculto', isPrivacidadeAtiva);
        });
    }

    // --- FUN√á√ïES DE CATEGORIAS E LOJAS ---
    
    function carregarLojas() {
        const lojas = getLojas();
        const datalist = document.getElementById('listaLojas');
        datalist.innerHTML = '';
        lojas.sort().forEach(loja => {
            const option = document.createElement('option');
            option.value = loja;
            datalist.appendChild(option);
        });
    }
    
    function carregarCategoriasESubcategorias() {
        const categorias = getCategorias();
        const tipoSelecionado = document.getElementById('tipoTransacao').value; 
        
        const selectCatTransacao = document.getElementById('categoriaTransacao');
        const selectCatFiltro = document.getElementById('filtroCategoria');
        
        // Limpa selects
        selectCatTransacao.innerHTML = '<option value="">Selecione uma categoria</option>';
        selectCatFiltro.innerHTML = '<option value="">Todas</option>';

        // 1. Carrega categorias do tipo selecionado (para a Nova Transa√ß√£o)
        const categoriasDoTipo = categorias[tipoSelecionado] || {};
        const nomesCategoriasDoTipo = Object.keys(categoriasDoTipo).sort(); 
        
        nomesCategoriasDoTipo.forEach(catName => {
            const option = document.createElement('option');
            option.value = catName;
            option.textContent = catName;
            selectCatTransacao.appendChild(option);
        });

        // 2. Carrega TODAS as categorias (para o Filtro de Relat√≥rios)
        const todasCategorias = new Set();
        for (const tipo in categorias) {
            for (const catName in categorias[tipo]) {
                todasCategorias.add(catName);
            }
        }
        
        // Adiciona as categorias ao select de Filtro
        Array.from(todasCategorias).sort().forEach(cat => {
            const optionFiltro = document.createElement('option');
            optionFiltro.value = cat;
            optionFiltro.textContent = cat;
            selectCatFiltro.appendChild(optionFiltro);
        });
        
        carregarSubcategoriasPorCategoria();
    }

    function carregarSubcategoriasPorCategoria() {
        const categorias = getCategorias();
        const tipo = document.getElementById('tipoTransacao').value;
        const categoriaSelecionada = document.getElementById('categoriaTransacao').value.trim(); 
        const selectSub = document.getElementById('subcategoriaTransacao');
        
        selectSub.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        
        if (!categoriaSelecionada) return;
        
        // Assegura que estamos pegando a categoria correta para o tipo selecionado
        const categoriaObj = categorias[tipo] && categorias[tipo][categoriaSelecionada];

        if (categoriaObj && categoriaObj.subcategorias) {
            categoriaObj.subcategorias.slice().sort().forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                selectSub.appendChild(option);
            });
        }
    }
    
    function carregarCategoriasModal() {
        const tipo = document.getElementById('modalTipo').value;
        const categorias = getCategorias();
        const selectCatModal = document.getElementById('modalSubCategoriaPai');
        
        selectCatModal.innerHTML = '<option value="">Selecione uma categoria</option>';
        
        const categoriasDoTipo = categorias[tipo] || {};
        const nomesCategoriasDoTipo = Object.keys(categoriasDoTipo).sort(); 
        
        nomesCategoriasDoTipo.forEach(catName => {
            const option = document.createElement('option');
            option.value = catName;
            option.textContent = catName;
            selectCatModal.appendChild(option);
        });
    }

    // --- FUN√á√ïES DE CRUD DE CATEGORIAS (APENAS NO MODAL) ---

    function abrirModalCategorias() {
        document.getElementById('modalCategorias').style.display = 'block';
        carregarCategoriasModal(); // Carrega categorias do modal
        exibirCategoriasParaGerenciamento(); 
    }

    function fecharModalCategorias() {
        document.getElementById('modalCategorias').style.display = 'none';
        carregarCategoriasESubcategorias(); // Recarrega os selects da Transa√ß√£o ap√≥s o gerenciamento
    }
    
    function cadastrarCategoriaModal() {
        const tipo = document.getElementById('modalTipo').value;
        const categoriaInput = document.getElementById('modalNovaCategoria');
        const categoriaNome = categoriaInput.value.trim();
        
        if (!categoriaNome) {
            alert('Erro: Digite o nome da nova Categoria.');
            return;
        }

        if (!confirm(`Deseja cadastrar a categoria "${categoriaNome}" para ${tipo}?`)) {
            return;
        }

        let categorias = getCategorias();
        
        // Garante que o tipo existe
        if (!categorias[tipo]) {
            categorias[tipo] = {};
        }

        // Verifica se a categoria j√° existe
        if (categorias[tipo][categoriaNome]) {
            alert(`ATEN√á√ÉO: Categoria '${categoriaNome}' (${tipo}) j√° existe.`);
            return;
        }

        // Adiciona a nova categoria
        categorias[tipo][categoriaNome] = { 
            nome: categoriaNome, 
            subcategorias: [] 
        };
        
        // Salva no localStorage
        setCategorias(categorias);
        
        // Limpa o input
        categoriaInput.value = '';
        
        // Atualiza as interfaces
        carregarCategoriasModal();
        exibirCategoriasParaGerenciamento();
        
        // Se o tipo selecionado no formul√°rio for o mesmo, atualiza tamb√©m
        if (document.getElementById('tipoTransacao').value === tipo) {
            carregarCategoriasESubcategorias();
        }
        
        alert(`SUCESSO: Categoria '${categoriaNome}' (${tipo}) cadastrada!`);
    }
    
    function cadastrarSubcategoriaModal() {
        const tipo = document.getElementById('modalTipo').value;
        const categoriaNome = document.getElementById('modalSubCategoriaPai').value.trim();
        const subInput = document.getElementById('modalNovaSubcategoria');
        const subNome = subInput.value.trim();

        if (!categoriaNome || !subNome) {
            alert('Erro: Selecione uma Categoria existente (Categoria Pai) e digite o nome da Subcategoria.');
            return;
        }

        if (!confirm(`Deseja cadastrar a subcategoria "${subNome}" para a categoria "${categoriaNome}"?`)) {
            return;
        }

        let categorias = getCategorias();
        
        // Verifica se a categoria existe
        if (!categorias[tipo] || !categorias[tipo][categoriaNome]) {
            alert(`Erro: Categoria Pai '${categoriaNome}' n√£o encontrada para o tipo ${tipo}.`);
            return;
        }
        
        const categoria = categorias[tipo][categoriaNome];

        // Verifica se a subcategoria j√° existe
        if (categoria.subcategorias.includes(subNome)) {
            alert(`ATEN√á√ÉO: Subcategoria '${subNome}' j√° existe em '${categoriaNome}'.`);
            return;
        }

        // Adiciona a nova subcategoria
        categoria.subcategorias.push(subNome);
        categoria.subcategorias.sort(); 
        
        // Salva no localStorage
        setCategorias(categorias);
        
        // Limpa os inputs
        subInput.value = '';
        document.getElementById('modalSubCategoriaPai').value = '';
        
        // Atualiza as interfaces
        exibirCategoriasParaGerenciamento();
        
        // Se a categoria selecionada no formul√°rio for a mesma, atualiza tamb√©m
        if (document.getElementById('categoriaTransacao').value === categoriaNome && 
            document.getElementById('tipoTransacao').value === tipo) {
            carregarSubcategoriasPorCategoria();
        }
        
        alert(`SUCESSO: Subcategoria '${subNome}' adicionada √† '${categoriaNome}' (${tipo}).`);
    }

    function exibirCategoriasParaGerenciamento() {
        const categorias = getCategorias();
        const display = document.getElementById('categoriasDisplay');
        display.innerHTML = '';

        const tipos = { despesa: 'Despesas', receita: 'Receitas' };

        for (const tipo in categorias) {
            const tipoDiv = document.createElement('div');
            tipoDiv.innerHTML = `<h3 style="margin-bottom: 0; color: ${tipo === 'despesa' ? '#dc3545' : '#28a745'}">${tipos[tipo]}</h3>`;
            display.appendChild(tipoDiv);

            const listaCats = categorias[tipo];
            const ul = document.createElement('ul');
            ul.classList.add('lista-categorias-ul');
            
            // Pega os nomes das categorias e ordena
            const nomesCategorias = Object.keys(listaCats).sort();

            nomesCategorias.forEach(catNome => {
                const catObj = listaCats[catNome];
                const li = document.createElement('li');
                
                const subcategoriasOrdenadas = catObj.subcategorias.slice().sort(); 
                
                let subHTML = '';
                if (subcategoriasOrdenadas.length > 0) {
                    subHTML = subcategoriasOrdenadas.map(sub => 
                        `<span style="white-space: nowrap;">${sub} <button class="btn btn-danger" style="padding: 3px 6px; font-size: 0.7em;" onclick="excluirSubcategoria('${catNome}', '${sub}', '${tipo}')">X</button></span>`
                    ).join(' | ');
                } else {
                    subHTML = 'Nenhuma Subcategoria';
                }
                
                li.innerHTML = `
                    <div style="flex-grow: 1; margin-right: 15px;">
                        <strong>${catNome}</strong>
                        <div style="font-size: 0.9em; margin-top: 5px; color: #555; max-height: 50px; overflow: auto; padding-right: 10px;">${subHTML}</div>
                    </div>
                    <button class="btn btn-danger" style="flex-shrink: 0;" onclick="excluirCategoria('${catNome}', '${tipo}')">Excluir Categoria</button>
                `;
                ul.appendChild(li);
            });
            
            if (nomesCategorias.length === 0) {
                ul.innerHTML = '<li>Nenhuma categoria cadastrada para este tipo.</li>';
            }
            
            display.appendChild(ul);
        }
    }
    
    function excluirCategoria(nome, tipo) {
        if (!confirm(`Tem certeza que deseja excluir a categoria '${nome}' (${tipo}) e todas as suas subcategorias?`)) {
            return;
        }
        
        const categorias = getCategorias();
        if (categorias[tipo] && categorias[tipo][nome]) {
             delete categorias[tipo][nome];
             setCategorias(categorias);
             exibirCategoriasParaGerenciamento(); // Recarrega a lista do modal
             carregarCategoriasESubcategorias(); // Atualiza selects de Transa√ß√£o
             alert(`Categoria '${nome}' exclu√≠da.`);
        }
    }

    function excluirSubcategoria(catNome, subNome, tipo) {
        if (!confirm(`Tem certeza que deseja excluir a subcategoria '${subNome}' de '${catNome}'?`)) {
            return;
        }
        
        const categorias = getCategorias();
        const categoria = categorias[tipo] && categorias[tipo][catNome];

        if (categoria) {
            const subcategorias = categoria.subcategorias;
            const index = subcategorias.indexOf(subNome);
            if (index > -1) {
                subcategorias.splice(index, 1);
                setCategorias(categorias);
                exibirCategoriasParaGerenciamento(); // Recarrega a lista do modal
                carregarCategoriasESubcategorias(); // Atualiza selects de Transa√ß√£o
                alert(`Subcategoria '${subNome}' exclu√≠da.`);
            }
        }
    }

    // --- FUN√á√ïES DE TRANSA√á√ÉO ---
    
    function salvarTransacao() {
        if (!confirm('Deseja realmente salvar esta(s) transa√ß√£o(√µes)?')) {
            return;
        }

        const data = document.getElementById('dataTransacao').value;
        const tipo = document.getElementById('tipoTransacao').value;
        const categoria = document.getElementById('categoriaTransacao').value.trim();
        const subcategoria = document.getElementById('subcategoriaTransacao').value.trim();
        const lojaTransacao = document.getElementById('lojaTransacao').value.trim();
        const descricaoTransacao = document.getElementById('descricaoTransacao').value.trim();
        const valorStr = document.getElementById('valorTransacao').value.replace(',', '.');
        const parcelas = parseInt(document.getElementById('parcelas').value);
        const status = document.getElementById('statusTransacao').value;

        if (!data || !valorStr || !categoria || !tipo || !descricaoTransacao || isNaN(parcelas) || parcelas < 1) {
            alert('Por favor, preencha Data, Valor, Categoria, Tipo, Descri√ß√£o e N√∫mero de Parcelas.');
            return;
        }
        
        const valor = parseFloat(valorStr);

        if (isNaN(valor) || valor <= 0) {
            alert('O valor deve ser um n√∫mero positivo.');
            return;
        }

        // Valida√ß√£o da Categoria 
        const categoriasExistentes = getCategorias()[tipo];
        if (!categoriasExistentes || !categoriasExistentes[categoria]) {
             alert(`A categoria '${categoria}' n√£o foi encontrada para o tipo ${tipo}. Por favor, use o bot√£o '+' ao lado do campo Categoria para ir em Configura√ß√µes e cadastr√°-la.`);
             return;
        }

        let transacoes = getTransacoes();
        
        // Cadastro impl√≠cito de Loja/Estabelecimento
        if(lojaTransacao) {
            let lojas = getLojas();
            if (!lojas.includes(lojaTransacao)) {
                lojas.push(lojaTransacao);
                setLojas(lojas);
            }
        }

        const valorParcela = valor / parcelas;
        const idOriginal = Date.now(); 
        
        // Gera√ß√£o de Parcelas
        for (let i = 0; i < parcelas; i++) {
            const dataInicial = new Date(data + 'T00:00:00');
            const dataParcela = new Date(dataInicial.setMonth(dataInicial.getMonth() + i));

            const novaTransacao = {
                id: idOriginal + i, 
                idOriginal: idOriginal, 
                // data.toISOString().split('T')[0] garante o formato YYYY-MM-DD
                data: dataParcela.toISOString().split('T')[0], 
                nome: lojaTransacao,
                descricao: (parcelas > 1) ? `${lojaTransacao || categoria} (${i + 1}/${parcelas}) - ${descricaoTransacao}` : descricaoTransacao,
                tipo: tipo,
                categoria: categoria,
                subcategoria: subcategoria,
                valor: valorParcela,
                parcelaAtual: i + 1,
                totalParcelas: parcelas,
                status: status 
            };
            transacoes.push(novaTransacao);
        }

        setTransacoes(transacoes);
        limparFormulario();
        atualizarDashboard();
        alert(`Transa√ß√£o de ${formatarMoeda(valor)} (${parcelas}x) salva com sucesso!`);
    }

    function limparFormulario() {
        document.getElementById('dataTransacao').valueAsDate = null;
        document.getElementById('tipoTransacao').value = 'despesa';
        document.getElementById('categoriaTransacao').value = '';
        document.getElementById('subcategoriaTransacao').value = '';
        document.getElementById('lojaTransacao').value = '';
        document.getElementById('descricaoTransacao').value = '';
        document.getElementById('valorTransacao').value = '';
        document.getElementById('parcelas').value = '1';
        atualizarStatusPadrao(); 
        carregarCategoriasESubcategorias();
    }
    
    function excluirTransacao(id) {
        if (!confirm('Tem certeza que deseja excluir esta transa√ß√£o? O valor dela ser√° revertido (devolvido/retirado) do seu Saldo.')) {
            return;
        }
        
        let transacoes = getTransacoes();
        transacoes = transacoes.filter(t => t.id !== id);
        
        setTransacoes(transacoes);
        atualizarDashboard();
        gerarRelatorio(); 
    }

    function alterarStatus(id, novoStatus) {
        if (!confirm('Deseja realmente alterar o status desta transa√ß√£o?')) {
            return;
        }
        
        let transacoes = getTransacoes();
        const transacaoIndex = transacoes.findIndex(t => t.id === id);
        
        if (transacaoIndex !== -1) {
            transacoes[transacaoIndex].status = novoStatus;
            setTransacoes(transacoes);
            atualizarDashboard();
            gerarRelatorio();
        }
    }

    function abrirModalDetalhes() {
        document.getElementById('modalDetalhesTransacao').style.display = 'block';
    }
    
    function fecharModalDetalhes() {
        document.getElementById('modalDetalhesTransacao').style.display = 'none';
    }

    function detalharTransacaoOriginal(idOriginal) {
        const todasTransacoes = getTransacoes();
        const transacoesDoGrupo = todasTransacoes.filter(t => t.idOriginal === idOriginal);
        
        if (transacoesDoGrupo.length === 0) return;

        const original = transacoesDoGrupo[0];
        const valorTotal = original.valor * original.totalParcelas;
        const detalhesDisplay = document.getElementById('detalhesDisplay');
        
        // Encontrar a descri√ß√£o original (sem a parte da parcela)
        const descricaoBase = original.descricao.replace(/\s\(\d+\/\d+\)/, '');

        let html = `
            <p><strong>Tipo:</strong> <span style="font-weight: bold; color: ${original.tipo === 'receita' ? '#28a745' : '#dc3545'};">${original.tipo.toUpperCase()}</span></p>
            <p><strong>Descri√ß√£o:</strong> ${descricaoBase}</p>
            <p><strong>Loja/Origem:</strong> ${original.nome || 'N/A'}</p>
            <p><strong>Categoria:</strong> ${original.categoria} / ${original.subcategoria || '-'}</p>
            <p><strong>Valor Total:</strong> <strong>${formatarMoeda(valorTotal)}</strong></p>
            <p><strong>Parcelas:</strong> ${original.totalParcelas}</p>
            <p><strong>Valor/Parcela:</strong> ${formatarMoeda(original.valor)}</p>
            
            <h3>Status das Parcelas</h3>
            <ul id="parcelasList" style="list-style-type: none; padding-left: 0;">
        `;

        transacoesDoGrupo.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(p => {
            const dataVencimento = new Date(p.data + 'T00:00:00');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); 
            
            const isVencida = dataVencimento < hoje && p.status !== 'Pago' && p.status !== 'Recebido';

            let statusDisplay = p.status;
            let statusColor = '#6c757d'; // Neutro
            
            if (isVencida) {
                statusDisplay = 'VENCIDO/ATRASADO';
                statusColor = '#dc3545';
            } else if (p.status === 'Pendente') {
                statusColor = '#ffc107'; 
            } else if (p.status === 'Pago' || p.status === 'Recebido') {
                statusColor = '#28a745';
            }
            
            html += `
                <li style="border-bottom: 1px dotted #eee; padding: 5px 0;">
                    ${p.parcelaAtual}/${p.totalParcelas} | Vencimento: ${p.data} | Valor: ${formatarMoeda(p.valor)} | 
                    Status: <strong style="color: ${statusColor};">${statusDisplay}</strong>
                </li>
            `;
        });

        html += `</ul>`;
        
        detalhesDisplay.innerHTML = html;
        abrirModalDetalhes();
    }

    // --- FUN√á√ïES DE DASHBOARD ---
    
    function atualizarDashboard() {
        const transacoes = getTransacoes();
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        const mesAtual = hoje.getMonth();
        const anoAtual = hoje.getFullYear();
        
        let saldoAtual = 0;
        let receitasMes = 0;
        let despesasMes = 0;
        let aPagarCount = 0;
        let aReceberCount = 0;
        let pendentesCount = 0;
        let pagosRecebidosCount = 0;
        
        transacoes.forEach(t => {
            const dataTransacao = new Date(t.data + 'T00:00:00');
            
            // C√ÅLCULO DO SALDO ATUAL (S√≥ contas quitadas)
            if (t.status === 'Recebido') {
                saldoAtual += t.valor;
            } else if (t.status === 'Pago') {
                saldoAtual -= t.valor;
            }

            // C√ÅLCULO DE RECEITAS/DESPESAS NO M√äS (Quitadas no m√™s de compet√™ncia)
            if (dataTransacao.getMonth() === mesAtual && dataTransacao.getFullYear() === anoAtual) {
                if (t.status === 'Recebido') {
                    receitasMes += t.valor;
                } else if (t.status === 'Pago') {
                    despesasMes += t.valor;
                }
            }
            
            // CONTAGEM POR STATUS
            if (t.status === 'A Pagar') {
                aPagarCount++;
            } else if (t.status === 'A Receber') {
                aReceberCount++;
            } else if (t.status === 'Pendente') {
                pendentesCount++;
            } else if (t.status === 'Pago' || t.status === 'Recebido') {
                pagosRecebidosCount++;
            }
        });

        document.getElementById('saldoAtual').textContent = formatarMoeda(saldoAtual);
        document.getElementById('receitasMes').textContent = formatarMoeda(receitasMes);
        document.getElementById('despesasMes').textContent = formatarMoeda(despesasMes);
        document.getElementById('aPagarCount').textContent = aPagarCount;
        document.getElementById('aReceberCount').textContent = aReceberCount;
        document.getElementById('pendentesCount').textContent = pendentesCount;
        document.getElementById('pagosRecebidosCount').textContent = pagosRecebidosCount;

        // Atualiza a classe de cor do saldo
        const saldoElement = document.getElementById('saldoAtual');
        saldoElement.classList.remove('soma-positiva', 'soma-negativa', 'soma-neutra');
        if (saldoAtual > 0) {
            saldoElement.classList.add('soma-positiva');
        } else if (saldoAtual < 0) {
            saldoElement.classList.add('soma-negativa');
        } else {
            saldoElement.classList.add('soma-neutra');
        }
    }

    // --- FUN√á√ïES DE RELAT√ìRIO ---
    
    function toggleDateFilters() {
        const periodo = document.getElementById('filtroPeriodo').value;
        const divDataInicio = document.getElementById('filtroDataPersonalizada');
        const divDataFim = document.getElementById('filtroDataPersonalizada2');
        
        if (periodo === 'personalizado') {
            divDataInicio.style.display = 'block';
            divDataFim.style.display = 'block';
        } else {
            divDataInicio.style.display = 'none';
            divDataFim.style.display = 'none';
        }
    }
    
    function gerarRelatorio() {
        const transacoes = getTransacoes();
        const periodo = document.getElementById('filtroPeriodo').value;
        const tipoFiltro = document.getElementById('filtroTipo').value;
        const categoriaFiltro = document.getElementById('filtroCategoria').value;
        const buscaFiltro = document.getElementById('filtroBusca').value.toLowerCase();
        
        let dataInicio, dataFim;
        const hoje = new Date();
        
        if (periodo === 'mes') {
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            dataFim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        } else if (periodo === '3meses') {
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 2, 1);
            dataFim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        } else if (periodo === '6meses') {
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 5, 1);
            dataFim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        } else if (periodo === '1ano') {
            dataInicio = new Date(hoje.getFullYear() - 1, hoje.getMonth(), 1);
            dataFim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        } else if (periodo === 'personalizado') {
            dataInicio = new Date(document.getElementById('dataInicio').value + 'T00:00:00');
            dataFim = new Date(document.getElementById('dataFim').value + 'T00:00:00');
        }
        
        // Verifica se as datas s√£o v√°lidas
        if (isNaN(dataInicio) || isNaN(dataFim)) {
            alert('Por favor, selecione um per√≠odo v√°lido.');
            return;
        }
        
        let somaReceitas = 0;
        let somaDespesas = 0;
        const tbody = document.getElementById('tabelaRelatorioBody');
        tbody.innerHTML = '';
        
        const transacoesFiltradas = transacoes.filter(t => {
            const dataTransacao = new Date(t.data + 'T00:00:00');
            const noPeriodo = dataTransacao >= dataInicio && dataTransacao <= dataFim;
            const tipoOk = !tipoFiltro || t.tipo === tipoFiltro;
            const categoriaOk = !categoriaFiltro || t.categoria === categoriaFiltro;
            const buscaOk = !buscaFiltro || 
                           t.descricao.toLowerCase().includes(buscaFiltro) || 
                           (t.nome && t.nome.toLowerCase().includes(buscaFiltro));
            
            return noPeriodo && tipoOk && categoriaOk && buscaOk;
        });
        
        // Ordena por data
        transacoesFiltradas.sort((a, b) => new Date(a.data) - new Date(b.data));
        
        transacoesFiltradas.forEach(t => {
            const dataVencimento = new Date(t.data + 'T00:00:00');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // Verifica se est√° vencida
            const isVencida = dataVencimento < hoje && t.status !== 'Pago' && t.status !== 'Recebido';
            
            // Soma para o resumo
            if (t.status === 'Recebido') {
                somaReceitas += t.valor;
            } else if (t.status === 'Pago') {
                somaDespesas += t.valor;
            }
            
            // Cria a linha da tabela
            const tr = document.createElement('tr');
            
            // Aplica classe especial se estiver vencida
            if (isVencida) {
                tr.classList.add('status-vencido');
            }
            
            // C√©lulas da tabela
            tr.innerHTML = `
                <td>${t.data}</td>
                <td>${t.descricao}</td>
                <td>${t.tipo}</td>
                <td>${t.categoria}</td>
                <td>${t.subcategoria || '-'}</td>
                <td>${formatarMoeda(t.valor)}</td>
                <td>${isVencida ? 'VENCIDO/ATRASADO' : t.status}</td>
                <td>
                    <button class="btn btn-info" style="padding: 3px 6px; font-size: 0.8em; margin-right: 5px;" onclick="detalharTransacaoOriginal(${t.idOriginal})">Detalhes</button>
                    <select onchange="alterarStatus(${t.id}, this.value)" style="padding: 3px; font-size: 0.8em;">
                        ${t.tipo === 'despesa' ? 
                            `<option value="A Pagar" ${t.status === 'A Pagar' ? 'selected' : ''}>A Pagar</option>
                             <option value="Pendente" ${t.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                             <option value="Pago" ${t.status === 'Pago' ? 'selected' : ''}>Pago</option>` :
                            `<option value="A Receber" ${t.status === 'A Receber' ? 'selected' : ''}>A Receber</option>
                             <option value="Pendente" ${t.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                             <option value="Recebido" ${t.status === 'Recebido' ? 'selected' : ''}>Recebido</option>`
                        }
                    </select>
                    <button class="btn btn-danger" style="padding: 3px 6px; font-size: 0.8em; margin-left: 5px;" onclick="excluirTransacao(${t.id})">Excluir</button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Atualiza o resumo
        document.getElementById('somaReceitas').textContent = formatarMoeda(somaReceitas);
        document.getElementById('somaDespesas').textContent = formatarMoeda(somaDespesas);
        document.getElementById('saldoRelatorio').textContent = formatarMoeda(somaReceitas - somaDespesas);
        
        // Atualiza a classe de cor do saldo do relat√≥rio
        const saldoRelatorioElement = document.getElementById('saldoRelatorio');
        saldoRelatorioElement.classList.remove('soma-positiva', 'soma-negativa', 'soma-neutra');
        if (somaReceitas - somaDespesas > 0) {
            saldoRelatorioElement.classList.add('soma-positiva');
        } else if (somaReceitas - somaDespesas < 0) {
            saldoRelatorioElement.classList.add('soma-negativa');
        } else {
            saldoRelatorioElement.classList.add('soma-neutra');
        }
    }

    // --- FUN√á√ïES DE RESET ---
    
    function resetarDados() {
        const senha = document.getElementById('senhaReset').value;
        
        if (senha !== PASS_RESET) {
            alert('Senha incorreta!');
            return;
        }
        
        if (!confirm('ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel e apagar√° TODOS os seus dados. Deseja continuar?')) {
            return;
        }
        
        localStorage.removeItem('transacoes');
        localStorage.removeItem('categorias');
        localStorage.removeItem('lojas');
        
        document.getElementById('senhaReset').value = '';
        atualizarDashboard();
        gerarRelatorio();
        carregarCategoriasESubcategorias();
        carregarLojas();
        
        alert('Todos os dados foram resetados com sucesso!');
    }

    // --- FUN√á√ïES DA CALCULADORA ---
    
    function atualizarDisplay() {
        document.getElementById('displayCalc').textContent = displayValue;
    }
    
    function digitoCalc(digito) {
        if (aguardandoSegundoOperando) {
            displayValue = digito;
            aguardandoSegundoOperando = false;
        } else {
            displayValue = displayValue === '0' ? digito : displayValue + digito;
        }
        atualizarDisplay();
    }
    
    function operadorCalc(proximoOperador) {
        const valorInput = parseFloat(displayValue.replace(',', '.'));
        
        if (primeiroOperando === null) {
            primeiroOperando = valorInput;
        } else if (operadorPendente) {
            const resultado = realizarCalculo();
            displayValue = String(resultado).replace('.', ',');
            primeiroOperando = resultado;
            atualizarDisplay();
        }
        
        aguardandoSegundoOperando = true;
        operadorPendente = proximoOperador;
    }
    
    function igualCalc() {
        if (operadorPendente === null || primeiroOperando === null) return;
        
        const resultado = realizarCalculo();
        displayValue = String(resultado).replace('.', ',');
        primeiroOperando = null;
        operadorPendente = null;
        aguardandoSegundoOperando = false;
        atualizarDisplay();
    }
    
    function realizarCalculo() {
        const segundoOperando = parseFloat(displayValue.replace(',', '.'));
        
        if (operadorPendente === '+') {
            return primeiroOperando + segundoOperando;
        } else if (operadorPendente === '-') {
            return primeiroOperando - segundoOperando;
        } else if (operadorPendente === '*') {
            return primeiroOperando * segundoOperando;
        } else if (operadorPendente === '/') {
            return primeiroOperando / segundoOperando;
        }
        
        return segundoOperando;
    }
    
    function limparCalc() {
        displayValue = '0';
        primeiroOperando = null;
        operadorPendente = null;
        aguardandoSegundoOperando = false;
        atualizarDisplay();
    }
    
    function apagarCalc() {
        displayValue = displayValue.slice(0, -1) || '0';
        atualizarDisplay();
    }

    // --- INICIALIZA√á√ÉO ---
    
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializa o sistema
        atualizarStatusPadrao();
        carregarCategoriasESubcategorias();
        carregarLojas();
        atualizarDashboard();
        gerarRelatorio();
        
        // Define a data atual como padr√£o
        document.getElementById('dataTransacao').valueAsDate = new Date();
    });
</script>

</body>
</html>
